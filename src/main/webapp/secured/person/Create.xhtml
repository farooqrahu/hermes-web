<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">

    <ui:composition>
        <p:dialog id="PersonCreateDlg" widgetVar="PersonCreateDialog" modal="true" resizable="false" appendTo="@(body)" header="#{bundle.CreatePersonTitle}" closeOnEscape="true">
            <!-- JYFR: Es necesario especificar 'enctype="multipart/form-data"' para poder subir archivos con la etiqueta 'p:fileUpload' -->
            <h:form id="PersonCreateForm">
                <p:tabView id="createTabView" dynamic="true" cache="true" rendered="#{personController.selected != null}" activeIndex="0">
                    <p:tab title="#{bundle.PersonalInfo}">
                        <p:panelGrid columns="2">
                            <p:outputLabel value="#{bundle.CreatePersonLabel_photo}" for="photo" />
                            <h:panelGroup>
                                <!-- TODO: Poner miniatura de la imagen subida -->
                                <p:fileUpload id="photo" fileUploadListener="#{personController.selected.uploadPhoto}" dragDropSupport="true"
                                              fileLimit="1"
                                              sizeLimit="40000"
                                              multiple="false"
                                              allowTypes="/(\.|\/)(gif|jpe?g|png)$/"
                                              label="#{bundle.Select}"
                                              uploadLabel="#{bundle.Load}"
                                              cancelLabel="#{bundle.Cancel}"/>
                            </h:panelGroup>
                            <p:outputLabel value="#{bundle.CreatePersonLabel_firstName}" for="firstName" />
                            <p:inputText id="firstName" value="#{personController.selected.firstName}" title="#{bundle.CreatePersonTitle_firstName}" required="true" requiredMessage="#{bundle.CreatePersonRequiredMessage_firstName}"/>
                            <p:outputLabel value="#{bundle.CreatePersonLabel_surname1}" for="surname1" />
                            <p:inputText id="surname1" value="#{personController.selected.surname1}" title="#{bundle.CreatePersonTitle_surname1}" required="true" requiredMessage="#{bundle.CreatePersonRequiredMessage_surname1}"/>
                            <p:outputLabel value="#{bundle.CreatePersonLabel_surname2}" for="surname2" />
                            <p:inputText id="surname2" value="#{personController.selected.surname2}" title="#{bundle.CreatePersonTitle_surname2}" required="true" requiredMessage="#{bundle.CreatePersonRequiredMessage_surname2}"/>
                            <p:outputLabel value="#{bundle.CreatePersonLabel_email}" for="email" />
                            <p:inputText id="email" value="#{personController.selected.email}" title="#{bundle.CreatePersonTitle_email}"  
                                         required="false" 
                                         validatorMessage="#{bundle.InvalidEmail}">
                                <!-- JYFR: Validación de e-mail que permite nulo, ya que es un campo opcional. Se ha encapsulado la expresi�n regular en '( )?' -->
                                <f:validateRegex pattern="(^[_A-Za-z0-9-\+]+(\.[_A-Za-z0-9-]+)*@[A-Za-z0-9-]+(\.[A-Za-z0-9]+)*(\.[A-Za-z]{2,})$)?" /> 
                            </p:inputText>
                            <p:outputLabel value="#{bundle.CreatePersonLabel_phone}" for="phone" />
                            <p:inputText id="phone" value="#{personController.selected.phone}" title="#{bundle.CreatePersonTitle_phone}" />
                            <p:outputLabel value="#{bundle.CreatePersonLabel_comments}" for="comments" />                      
                            <h:panelGroup>
                                <p:inputTextarea id="comments" value="#{personController.selected.comments}" title="#{bundle.CreatePersonTitle_comments}" rows="5" cols="30" counter="counterDisplay" maxlength="255" counterTemplate="#{bundle.RemainingCharacters}" autoResize="false" />
                                <br/>
                                <h:outputText id="counterDisplay" />
                            </h:panelGroup>
                        </p:panelGrid>
                    </p:tab>
                    <p:tab title="#{bundle.Fitbit}">
                        <p:panelGrid columns="2">
                            <p:outputLabel value="#{bundle.CreatePersonLabel_fitbitUserId}" for="fitbitUserId" />
                            <p:inputText id="fitbitUserId" value="#{personController.selected.fitbitUserId}" title="#{bundle.CreatePersonLabel_fitbitUserId}" />
                            <p:outputLabel value="#{bundle.CreatePersonLabel_fitbitAccessToken}" for="fitbitAccessToken" />
                            <p:inputText id="fitbitAccessToken" value="#{personController.selected.fitbitAccessToken}" title="#{bundle.CreatePersonTitle_fitbitAccessToken}" />
                            <p:outputLabel value="#{bundle.CreatePersonLabel_fitbitAccessTokenSecret}" for="fitbitAccessTokenSecret" />
                            <p:inputText id="fitbitAccessTokenSecret" value="#{personController.selected.fitbitAccessTokenSecret}" title="#{bundle.CreatePersonTitle_fitbitAccessTokenSecret}" />
                        </p:panelGrid>
                    </p:tab>
                    <p:tab title="#{bundle.PersonalParameters}" rendered="#{userLogin.user.admin or userLogin.user.doctor}">
                        <p:panelGrid columns="2">
                            <p:outputLabel value="#{bundle.StepsGoal}" for="stepsGoal" />
                            <p:inputText id="stepsGoal" value="#{personController.selected.configurationHashMap.StepsGoal.value}" title="#{bundle.StepsGoal}" required="true" />
                            <p:outputLabel value="#{bundle.MinimumSessionMinutes}" for="minSessionMinutes" />
                            <p:inputText id="minSessionMinutes" value="#{personController.selected.configurationHashMap.MinimumSessionMinutes.value}" title="#{bundle.MinimumSessionMinutes}" required="true" />
                            <p:outputLabel value="#{bundle.RestStepsThreshold}" for="restStepsThreshold" />
                            <p:inputText id="restStepsThreshold" value="#{personController.selected.configurationHashMap.RestStepsThreshold.value}" title="#{bundle.RestStepsThreshold}" required="true" />
                            <p:outputLabel value="#{bundle.EndSessionStoppedMinutes}" for="endSessionStoppedMinutes" />
                            <p:inputText id="endSessionStoppedMinutes" value="#{personController.selected.configurationHashMap.EndSessionStoppedMinutes.value}" title="#{bundle.EndSessionStoppedMinutes}" required="true" />
                            <p:outputLabel value="#{bundle.SessionsPerWeek}" for="sessionsPerWeek" />
                            <p:inputText id="sessionsPerWeek" value="#{personController.selected.configurationHashMap.SessionsPerWeek.value}" title="#{bundle.SessionsPerWeek}" required="true" />
                        </p:panelGrid>
                    </p:tab>
                    <p:tab title="#{bundle.AccessData}">
                        <p:panelGrid columns="2">
                            <p:outputLabel value="#{bundle.Username}" for="username" />
                            <p:inputText id="username" value="#{personController.selected.username}" title="#{bundle.Username}" required="true" requiredMessage="#{bundle.RegisterPersonRequiredMessage_username}">
                                <f:validator validatorId="es.jyago.hermes.person.UsernameValidator" />
                            </p:inputText>
                            <p:outputLabel value="#{bundle.Password}" for="password" />
                            <p:password id="password" value="#{personController.selected.password}" title="#{bundle.Password}" required="true" requiredMessage="#{bundle.RegisterPersonRequiredMessage_password}"/>
                            <p:outputLabel value="#{bundle.EditPersonLabel_roleId}" for="roleId" />
                            <p:selectOneMenu id="roleId" value="#{personController.selected.role}" required="true" requiredMessage="#{bundle.CreatePersonRequiredMessage_roleId}">
                                <f:selectItem itemLabel="#{bundle.SelectOneMessage}"/>
                                <f:selectItems value="#{roleController.getItemsAvailableSelectOneLessThanMine(userLogin.user.role)}"
                                               var="roleIdItem"
                                               itemValue="#{roleIdItem}"/>
                            </p:selectOneMenu>
                        </p:panelGrid>
                    </p:tab>
                </p:tabView>
                <p:commandButton actionListener="#{personController.create}" value="#{bundle.Save}" update=":PersonListForm:datalist,:messages" oncomplete="handleSubmit(args,'PersonCreateDialog');"/>
                <!-- JYFR: Indicamos el atributo 'immediate="true"' para evitar que se hagan las validaciones AJAX al cancelar -->
                <p:commandButton value="#{bundle.Cancel}" onclick="PF('PersonCreateDialog').hide()" immediate="true"/>
            </h:form>
        </p:dialog>
    </ui:composition>
</html>
