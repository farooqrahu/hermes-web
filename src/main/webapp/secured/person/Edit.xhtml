<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">

    <ui:composition>
        <p:dialog id="PersonEditDlg" widgetVar="PersonEditDialog" modal="true" resizable="false" appendTo="@(body)" header="#{bundle.EditPersonTitle}" closeOnEscape="true" closable="true">
            <!-- JYFR: Es necesario especificar 'enctype="multipart/form-data"' para poder subir archivos con la etiqueta 'p:fileUpload' -->
            <h:form id="PersonEditForm" enctype="multipart/form-data">
                <!-- JYFR: Post validación -->
                <f:event listener="#{personController.validate()}" type="postValidate" />

                <p:tabView dynamic="true" cache="true" rendered="#{personController.selected != null}" activeIndex="0">
                    <p:tab title="#{bundle.PersonalInfo}">
                        <p:panelGrid columns="2">
                            <p:outputLabel value="#{bundle.EditPersonLabel_photo}" for="photo" />
                            <h:panelGroup>
                                <p:graphicImage id="currentPhoto" value="#{imageStreamer.photoImage}" height="50px" width="50px" style="border: 1px solid;">
                                    <f:param name="personId" value="#{personController.selected.personId}" />
                                </p:graphicImage>
                                <!-- TODO: Poner miniatura de la imagen subida -->
                                <p:fileUpload id="photo" fileUploadListener="#{personController.selected.uploadPhoto}" dragDropSupport="true"
                                              sizeLimit="40000"
                                              multiple="false"
                                              allowTypes="/(\.|\/)(gif|jpe?g|png)$/"
                                              label="#{bundle.Select}"
                                              uploadLabel="#{bundle.Load}"
                                              cancelLabel="#{bundle.Cancel}"
                                              update="currentPhoto"/>
                            </h:panelGroup>
                            <p:outputLabel value="#{bundle.EditPersonLabel_firstName}" for="firstName" />
                            <p:inputText id="firstName" value="#{personController.selected.firstName}" title="#{bundle.EditPersonTitle_firstName}" required="true" requiredMessage="#{bundle.EditPersonRequiredMessage_firstName}"/>
                            <p:outputLabel value="#{bundle.EditPersonLabel_surname1}" for="surname1" />
                            <p:inputText id="surname1" value="#{personController.selected.surname1}" title="#{bundle.EditPersonTitle_surname1}" required="true" requiredMessage="#{bundle.EditPersonRequiredMessage_surname1}"/>
                            <p:outputLabel value="#{bundle.EditPersonLabel_surname2}" for="surname2" />
                            <p:inputText id="surname2" value="#{personController.selected.surname2}" title="#{bundle.EditPersonTitle_surname2}" required="true" requiredMessage="#{bundle.EditPersonRequiredMessage_surname2}"/>
                            <p:outputLabel value="#{bundle.EditPersonLabel_email}" for="email" />
                            <p:inputText id="email" value="#{personController.selected.email}" title="#{bundle.EditPersonTitle_email}"
                                         required="false" 
                                         validatorMessage="#{bundle.InvalidEmail}">
                                <!-- JYFR: Validación de e-mail que permite nulo, ya que es un campo opcional. Se ha encapsulado la expresi�n regular en '( )?' -->
                                <f:validateRegex pattern="(^[_A-Za-z0-9-\+]+(\.[_A-Za-z0-9-]+)*@[A-Za-z0-9-]+(\.[A-Za-z0-9]+)*(\.[A-Za-z]{2,})$)?" /> 
                            </p:inputText>
                            <p:outputLabel value="#{bundle.EditPersonLabel_phone}" for="phone" />
                            <p:inputText id="phone" value="#{personController.selected.phone}" title="#{bundle.EditPersonTitle_phone}" />
                            <p:outputLabel value="#{bundle.EditPersonLabel_comments}" for="comments" />
                            <h:panelGroup>
                                <p:inputTextarea  id="comments" value="#{personController.selected.comments}" title="#{bundle.EditPersonTitle_comments}" rows="5" cols="30" counter="counterDisplay" maxlength="255" counterTemplate="#{bundle.RemainingCharacters}" autoResize="false" />
                                <br/>
                                <h:outputText id="counterDisplay" />
                            </h:panelGroup>
                        </p:panelGrid>
                    </p:tab>
                    <p:tab title="#{bundle.Fitbit}">
                        <p:panelGrid columns="2">
                            <p:outputLabel value="#{bundle.EditPersonLabel_fitbitUserId}" for="fitbitUserId" />
                            <p:inputText id="fitbitUserId" value="#{personController.selected.fitbitUserId}" title="#{bundle.EditPersonLabel_fitbitUserId}" />
                            <p:outputLabel value="#{bundle.EditPersonLabel_fitbitAccessToken}" for="fitbitAccessToken" />
                            <p:inputText id="fitbitAccessToken" value="#{personController.selected.fitbitAccessToken}" title="#{bundle.EditPersonTitle_fitbitAccessToken}" />
                            <p:outputLabel value="#{bundle.EditPersonLabel_fitbitAccessTokenSecret}" for="fitbitAccessTokenSecret" />
                            <p:inputText id="fitbitAccessTokenSecret" value="#{personController.selected.fitbitAccessTokenSecret}" title="#{bundle.EditPersonTitle_fitbitAccessTokenSecret}" />
                        </p:panelGrid>
                    </p:tab>
                    <p:tab title="#{bundle.PersonalParameters}">
                        <p:panelGrid columns="2">
                            <p:outputLabel value="#{bundle.EditPersonLabel_stepsGoal}" for="stepsGoal" />
                            <p:inputText id="stepsGoal" value="#{personController.selected.stepsGoal}" title="#{bundle.EditPersonLabel_stepsGoal}" />
                            <p:outputLabel value="#{bundle.EditPersonLabel_minimumSessionMinutes}" for="minSessionMinutes" />
                            <p:inputText id="minSessionMinutes" value="#{personController.selected.minSessionMinutes}" title="#{bundle.EditPersonLabel_minimumSessionMinutes}" />
                            <p:outputLabel value="#{bundle.EditPersonLabel_restStepsThreshold}" for="restStepsThreshold" />
                            <p:inputText id="restStepsThreshold" value="#{personController.selected.restStepsThreshold}" title="#{bundle.EditPersonLabel_restStepsThreshold}" />

                        </p:panelGrid>
                    </p:tab>
                    <p:tab title="#{bundle.AccessData}">
                        <p:panelGrid columns="2">
                            <p:outputLabel value="#{bundle.Username}" for="username" />
                            <p:inputText id="username" value="#{personController.selected.username}" title="#{bundle.Username}" />
                            <p:outputLabel value="#{bundle.Password}" for="password" />
                            <p:password id="password" value="#{personController.selected.password}" title="#{bundle.Password}" />
                            <p:outputLabel value="#{bundle.EditPersonLabel_roleId}" for="roleId" />
                            <p:selectOneMenu id="roleId" value="#{personController.selected.role}" required="true" requiredMessage="#{bundle.EditPersonRequiredMessage_roleId}">
                                <f:selectItem itemLabel="#{bundle.SelectOneMessage}"/>
                                <f:selectItems value="#{roleController.getItemsAvailableSelectOneLessThanMine(userLogin.user.role)}"
                                               var="roleIdItem"
                                               itemValue="#{roleIdItem}"/>
                            </p:selectOneMenu>
                        </p:panelGrid>
                    </p:tab>
                </p:tabView>
                <p:commandButton actionListener="#{personController.update}" value="#{bundle.Save}" update=":PersonListForm:datalist,:messages" oncomplete="handleSubmit(args, 'PersonEditDialog');"/>
                <!-- JYFR: Indicamos el atributo 'immediate="true"' para evitar que se hagan las validaciones AJAX al cancelar -->
                <p:commandButton value="#{bundle.Cancel}" onclick="PF('PersonEditDialog').hide()" immediate="true" rendered="#{(personController.selected != null) and (personController.selected.personId != null)}" />
            </h:form>
        </p:dialog>
    </ui:composition>
</html>
